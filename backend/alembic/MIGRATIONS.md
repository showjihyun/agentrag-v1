# Alembic Migrations Guide

**Last Updated**: 2026-01-20  
**Current Version**: 20260120_plugin_marketplace

---

## üìã Active Migrations

### Migration Chain

```
20260120_plugin_marketplace (HEAD) ‚úÖ
    ‚Üì
20260120_create_missing_tables ‚úÖ
    ‚Üì
20260115220929_add_context_and_mcp_to_agents ‚úÖ
    ‚Üì
9ce227b568e8_initial_schema ‚úÖ
```

---

## üóÇÔ∏è Migration Files

### 1. Initial Schema (9ce227b568e8)
**File**: `9ce227b568e8_initial_schema.py`  
**Date**: 2025-10-06

**Creates**:
- users
- documents
- agents
- agent_templates
- agentflows
- blocks
- chatflows
- flow_executions
- knowledge_bases
- messages
- prompt_templates
- sessions
- tools
- workflows

**Total**: 14 base tables

---

### 2. Add Context and MCP to Agents (20260115220929)
**File**: `20260115220929_add_context_and_mcp_to_agents.py`  
**Date**: 2026-01-15

**Adds to agents table**:
- `context_items` (JSONB) - List of context items (files, folders, etc.)
- `mcp_servers` (JSONB) - List of MCP server configurations

**Purpose**: Enable MCP (Model Context Protocol) support and context management

---

### 3. Create Missing Tables (20260120_create_missing_tables)
**File**: `20260120_create_missing_tables.py`  
**Date**: 2026-01-20

**Creates** (20 tables):
1. **conversations** - Conversation management
2. **feedback** - User feedback
3. **agent_versions** - Agent version history
4. **agent_tools** - Agent-tool associations
5. **agent_knowledgebases** - Agent-KB associations
6. **agent_executions** - Agent execution logs
7. **agent_memories** - Agent memory storage
8. **organizations** - Organization management
9. **teams** - Team management
10. **bookmarks** - User bookmarks
11. **notifications** - User notifications
12. **conversation_shares** - Conversation sharing
13. **api_keys** - API key management
14. **event_store** - Event sourcing
15. **agentflow_agents** - Agentflow agent placement
16. **agentflow_edges** - Agentflow connections
17. **knowledge_graphs** - Knowledge graph storage
18. **tool_executions** - Tool execution logs
19. **query_logs** - Query logging
20. **user_settings** - User preferences

**Purpose**: Complete core functionality tables

---

### 4. Create Plugin & Marketplace Tables (20260120_plugin_marketplace)
**File**: `20260120_create_plugin_marketplace_tables.py`  
**Date**: 2026-01-20

**Creates** (11 tables):

**Plugin System** (6 tables):
1. **plugin_registry** - Plugin metadata
2. **plugin_configurations** - Plugin settings
3. **plugin_metrics** - Plugin performance metrics
4. **plugin_dependencies** - Plugin dependencies
5. **plugin_audit_logs** - Plugin audit trail
6. **plugin_security_scans** - Security scan results

**Marketplace** (3 tables):
7. **marketplace_purchases** - Purchase records
8. **marketplace_reviews** - User reviews
9. **marketplace_revenue** - Revenue tracking

**Credits & Rate Limiting** (2 tables):
10. **credits** - Credit transactions
11. **rate_limit_configs** - Rate limit settings

**Purpose**: Enable plugin ecosystem and marketplace

---

## üìä Database Statistics

| Metric | Count |
|--------|-------|
| Total Tables | 47 |
| Core Tables | 14 |
| Agent Tables | 7 |
| Plugin Tables | 6 |
| Marketplace Tables | 3 |
| Organization Tables | 2 |
| Flow Tables | 4 |
| Other Tables | 11 |

---

## üöÄ Usage

### Check Current Version
```bash
cd backend
alembic current
```

### View Migration History
```bash
alembic history --verbose
```

### Upgrade to Latest
```bash
alembic upgrade head
```

### Upgrade to Specific Version
```bash
alembic upgrade 20260120_plugin_marketplace
```

### Downgrade One Version
```bash
alembic downgrade -1
```

### Downgrade to Specific Version
```bash
alembic downgrade 20260115220929
```

---

## üîß Creating New Migrations

### Auto-generate Migration
```bash
alembic revision --autogenerate -m "description"
```

### Manual Migration
```bash
alembic revision -m "description"
```

### Migration Template
```python
"""description

Revision ID: <auto-generated>
Revises: <previous-revision>
Create Date: <timestamp>

"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision: str = '<auto-generated>'
down_revision: Union[str, None] = '<previous-revision>'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Apply migration."""
    pass


def downgrade() -> None:
    """Revert migration."""
    pass
```

---

## üì¶ Archived Migrations

48 migration files have been archived to `versions/archive/`.

These files are no longer needed as the schema has been consolidated into the 4 essential migrations above.

See `versions/archive/README.md` for the complete list.

---

## üîç Schema Export

### Export Current Schema
```bash
python backend/scripts/export_schema.py
```

**Output**: `backend/schemas/schema_latest.sql`

This creates a complete SQL dump of the current database schema, useful for:
- Documentation
- Fresh database setup
- Schema comparison
- Backup

---

## ‚ö†Ô∏è Important Notes

### Before Running Migrations

1. **Backup Database**
   ```bash
   pg_dump -U postgres -d agenticrag > backup.sql
   ```

2. **Check Current State**
   ```bash
   alembic current
   ```

3. **Review Migration**
   ```bash
   alembic show <revision>
   ```

### After Running Migrations

1. **Verify Success**
   ```bash
   alembic current
   ```

2. **Test Application**
   - Run unit tests
   - Check API endpoints
   - Verify data integrity

3. **Update Documentation**
   - Update this file if needed
   - Document any breaking changes

---

## üêõ Troubleshooting

### Migration Fails

1. **Check Error Message**
   - Read the full error output
   - Identify the failing SQL statement

2. **Check Database State**
   ```bash
   psql -U postgres -d agenticrag
   \dt  # List tables
   \d table_name  # Describe table
   ```

3. **Rollback if Needed**
   ```bash
   alembic downgrade -1
   ```

### Multiple Heads

If you see "Multiple heads detected":

```bash
# View all heads
alembic heads

# Merge heads
alembic merge -m "merge heads" <rev1> <rev2>
```

### Revision Not Found

If a revision is not found:

1. Check `alembic_version` table
2. Verify migration files exist
3. Check for typos in revision IDs

---

## üìö Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)

---

## üîÑ Migration Workflow

### Development

1. Make model changes
2. Generate migration: `alembic revision --autogenerate -m "description"`
3. Review generated migration
4. Test migration: `alembic upgrade head`
5. Test downgrade: `alembic downgrade -1`
6. Commit migration file

### Production

1. Backup database
2. Review migration in staging
3. Schedule maintenance window
4. Apply migration: `alembic upgrade head`
5. Verify application
6. Monitor for issues

---

**Maintained by**: Database Team  
**Contact**: For questions, see project documentation
